# 变更检测

## 默认

默认策略是最常用的策略，Angular 会自动检测组件及其子组件的所有变化

适用于大多数情况，但可能会导致性能问题，特别是在大型应用中。

## Onpush

OnPush 策略

OnPush 策略是一种优化策略，适用于纯组件（即组件的输出只依赖于输入）。启用 OnPush 策略后，Angular 只在以下情况下才会检查组件的变更：

1. 组件的输入属性发生变化
2. 组件接收到新的事件（如 @Input、@Output）
3. 组件内的异步操作完成（如 Promise、Observable）
4. 通过 ChangeDetectorRef.markForCheck

要启用 OnPush 策略，可以在组件装饰器中设置 changeDetection 属性：

<mark style="color:red;">仅在输入属性（@Input）发生变化或事件触发时进行变更检测。</mark>

适用于纯组件（没有副作用的组件），可以提高性能。

## ChangeDetectorRef&#x20;

是 Angular 中一个非常重要的类，它提供了对组件变更检测机制的细粒度控制。

ChangeDetectorRef 提供了几种方法来管理变更检测过程：

1. markForCheck()：当使用 OnPush 策略时，如果组件的输入属性没有发生变化，但你仍然希望该组件及其祖先组件被检查，则可以调用此方法。这将使得即使没有触发器，也会检查该组件（<mark style="color:red;">markForCheck() 不会立即触发变更检测，而是将当前组件及所有父组件标记为需要检测的状态</mark>。这意味着如果一个组件或其某个祖先组件使用了 OnPush 策略，调用 markForCheck() 后，Angular 将会在下一次全局变更检测时重新评估这些组件的状态，）
2. detach()：从变更检测树中移除当前组件的变更检测器。这意味着该组件及其子组件将不再执行变更检测，直到重新附加为止。这对于避免不必要的变更检测非常有用，特别是在处理大量数据或复杂计算时
3. reattach()：将之前分离出去的变更检测器重新添加回变更检测树中，从而使组件能够再次参与变更检测流程。通常与 detach() 一起使用，以实现局部变更检测8。
4. detectChanges()：强制立即对该组件及其所有子组件执行一次变更检测。这对于确保视图及时反映最新的数据状态特别有帮助，尤其是在异步操作完成之后1。
5. checkNoChanges()：用于调试目的，检查是否存在未预期的状态更改。它会抛出错误，如果发现任何脏值（即未经处理的数据变更）。这个方法在开发阶段很有用，但在生产环境中应该谨慎使用，因为它可能会导致性能问题8
