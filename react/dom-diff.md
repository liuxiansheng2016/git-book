# Dom diff

计算出Virtual DOM中真正变化的部分，并只针对该部分进行原生DOM操作，而非重新渲染整个页面。

#### React Diff 的主要步骤

1. **生成虚拟 DOM 树**：当组件重新渲染时，React 会生成新的虚拟 DOM 树。
2. **比较新旧虚拟 DOM 树**：React 将新的虚拟 DOM 树与旧的虚拟 DOM 树进行比较，找出差异。
3. **应用差异**：React 将找出的差异应用到实际的 DOM 上，只更新需要更改的部分

React Diff 的比较规则主要包括以下几点：

* **相同类型的节点**：如果新旧树中的节点类型相同（例如都是 `<div>` 或 `<span>`），那么只会比较它们的属性和子节点。
* **不同类型的节点**：如果新旧树中的节点类型不同，则旧节点将被完全替换。
* **键（key）**：如果节点带有 `key` 属性，React 会使用 `key` 来唯一标识节点。这有助于 React 更精确地识别节点，从而减少不必要的重新渲染。
* **属性和状态**：比较节点的属性（如 `className`、`style` 等）和状态（如 `state`），如果发现不同，则更新相应的属性或状态。
* **子节点**：递归比较子节点，找出子节点之间的差异。

&#x20;

React 将 diff 分为三个阶段：tree diff、component diff 和 element diff1。

Tree Diff

Tree diff 涉及的是对整个组件树的不同层级之间的比较。由于 Web UI 中 DOM 节点跨层级的移动操作较少，React 选择只在同一层次内的节点间进行比较。如果某个节点不再存在于新树中，则该节点及其所有子节点都将被移除；反之，新增加的节点会被插入到适当的位置。这样做的好处是可以显著减少不必要的遍历次数1。

Component Diff

Component diff 主要是针对同类型的组件实例之间的比较。如果两个组件属于同一类别，那么 React 会继续深入比较它们各自的子树；但如果组件类型不同，则旧组件及其所有子节点将被替换为新的组件树。此外，React 允许开发者通过 shouldComponentUpdate 方法自定义是否需要执行 diff 算法，以此避免不必要的计算1。

Element Diff

Element diff 是指在同一层级的所有节点之间进行比较。当节点处于同一层级时，diff 提供了三种操作：INSERT\_MARKUP（插入）、MOVE\_EXISTING（移动）和 REMOVE\_NODE（删除）。例如，当旧集合中的节点 A、B、C 和 D 更新为新集合中的 B、A、D 和 C 时，React 不会尝试移动现有的节点，而是重新创建这些节点并按照新的顺序插入。这样做虽然看起来效率不高，但实际上对于大多数情况而言已经足够好，因为 Web 应用程序中的元素重排并不频繁
